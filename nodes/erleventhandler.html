<script type="text/javascript">
  (function(){
    
  RED.nodes.registerType('erleventhandler',{
    color: '#FFCC66',
    icon: "font-awesome/fa-snowflake-o",
    category: 'behaviour',
    paletteLabel: 'Event Handler',
    defaults: {
      name: {
        value:"",
      },
      handlers: {
        value: [{ 
          nodeid: "",  // node id of the module with the code
          moduleterm: "", // (optional) unique id for the module if instantiated multiple times
          arg: "" // (optional) a single string as argument in case something needs to be passed to the module
        }]
      }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      let allModules = [ ["", "-- select module --"], ...RED.nodes.filterNodes({ type: "erlmodule" }).map( d => [d.id, d.module_name] )]

      if ( this.handlers.length == 0 ) {
        this.handlers.push({ nodeid: "", moduleterm: "", arg: ""})
      }

      this.handlers.sort((a, b) => a.nodeid < b.nodeid).forEach(currVal => {
        var sltObj = $('<select>', { class: 'erleventhandler-erlmodule', style: "width: 30%; min-width: 150px;" })

        for (var idx = 0; idx < allModules.length; idx++) {
          let val = allModules[idx]
          let selected = val[0] == currVal.nodeid ? { selected: "selected" } : {}

          sltObj.append($("<option>", { value: val[0], ...selected }).append(val[1]))
        }

        var txtObj = $('<input>', { type: "text", value: currVal.moduleterm, placeholder: "Module Id", style: "margin-left: 5px; width: 20%; min-width: 100px;", class: "erleventhandler-erlterm" })
        var argObj = $('<input>', { type: "text", value: currVal.arg, placeholder: "Argument", style: "margin-left: 5px; width: 30%; min-width: 150px;", class: "erleventhandler-erlarg" })

        var container = $("<div>", { class: "form-row" });

        container.append('<a href="#" style="margin-right: 7px; color: green;" onclick="$(\'#erleventhandler-handler-config-container\').append($(this).parent().clone()); return false;"><i class="fa fa-plus"></i></a>')
        container.append('<a href="#" style="margin-right: 7px; color: red;" onclick="$(this).parent().remove(); return false;"><i class="fa fa-close"></i></a>')

        container.append("<br>").append(sltObj).append(txtObj).append(argObj)

        container.appendTo($('#erleventhandler-handler-config-container'))
      })      
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      let result = []
      $($('#erleventhandler-handler-config-container').find('.erleventhandler-erlmodule')).each((idx, elem) => {
        result.push({ 
          nodeid: $(elem).val(), 
          moduleterm: $(elem).siblings().filter(".erleventhandler-erlterm").val(),
          arg: $(elem).siblings().filter(".erleventhandler-erlarg").val() 
        })
      })
      this.handlers = result
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="erleventhandler">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class='form-row'><i class="fa fa-handshake-o"></i> <span>Static Handlers</span></div>
  
  <div id="erleventhandler-handler-config-container"></div>
</script>
