<script type="text/javascript">
  (function(){
  
  RED.nodes.registerType('erlmodule',{
    color: '#fdd0a2',
    icon: "font-awesome/fa-keyboard-o",
    category: 'function',
    paletteLabel: 'Module Code',
    defaults: {
      name: {
        value: "",
      },
      module_name: {
        value:"",
        required: true,
        validate: RED.validators.regex(/^[a-z0-9_]+$/)        
      },
      code: {
        value: "-module().\n\n-import(module, [\n   funct/1\n]).\n\n\n-export([\n   something/1\n]).\n\nsomething(V) ->\n  io:format(\"hello world~n\",[]).\n\n",
        required: true
      }
    },

    inputs: 0,

    outputs: 0,

    label: function() {
      return (this.name || this.module_name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      var node = this;

      this.editor = RED.editor.createEditor({
        id: 'node-input-erlmodule-editor',
        mode: 'ace/mode/erlang',
        value: this.code,
        width: "Infinity",
        height: "calc(90vh)",
        focus: true
      });

      $('.template-button').on('click', (e) =>{
        let templateCode = {
          "module": "-module(module_code_one).\n\n-import(module, [\n   funct/1\n]).\n\n\n-export([\n   something/1\n]).\n\nsomething(V) ->\n  io:format(\"hello world ~p ~n\",[V]).\n\n",


          "server": "-module(module_code_server).\n\n%%\n%% APIs: https://www.erlang.org/doc/apps/stdlib/gen_server.html\n%%\n\n-behaviour(gen_server).\n\n-export([\n    start_link/0,\n    init/1,\n    handle_call/3,\n    handle_cast/2,\n    handle_info/2,\n    code_change/3,\n    terminate/2,\n    stop/0\n]).\n\nstart_link() ->\n    gen_server:start_link({local, ?MODULE}, ?MODULE, #{}, []).\n\ninit(#{}) ->\n    {ok, #{}}.\n\nstop() ->\n    gen_server:cast(?MODULE, stop).\n\nterminate(normal, _State) ->\n    ok;\nterminate(_Event, _State) ->\n    ok.\n\ncode_change(_OldVersion, State, _Extra) ->\n    {ok, State}.\n\n%%\n%%\nhandle_call(_Msg, _From, State) ->\n    {reply, ok, State}.\n\n%%\n%%\nhandle_cast(stop, State) ->\n    {stop, normal, State};\nhandle_cast(_Msg, State) ->\n    {noreply, State}.\n\n%%\n%%\nhandle_info(_, State) ->\n    {noreply, State}.\n\n",


          "event": "-module().\n\n%%\n%% APIs https://www.erlang.org/doc/apps/stdlib/gen_event.html\n%%\n\n-behaviour(gen_event).\n\n-export([\n    init/1,\n    handle_event/2,\n    handle_call/2,\n    handle_info/2,\n    terminate/2,\n    code_change/3\n]).\n\ninit(Args) ->\n    {ok, Args}.\n\nhandle_event(_Event, State) ->\n    {ok, State}.\n\nhandle_call(_Request, State) ->\n    {ok, ok, State}.\n\nhandle_info(_Info, State) ->\n    {ok, State}.\n\nterminate(_Reason, _State) ->\n    ok.\n\ncode_change(_OldVsn, State, _Extra) ->\n    {ok, State}.\n",


          "state": "-module().\n\n%%\n%%  APIs: https://www.erlang.org/doc/apps/stdlib/gen_statem.html\n%%\n\n-behaviour(gen_statem).\n\n-export([\n    start/0,\n    init/1,\n    callback_mode/0,\n    handle_event/4,\n    code_change/4,\n    terminate/3,\n    stop/0\n]).\n\n%% WARNING: state_functions are not supported by statemachine node.\n%% callback_mode() -> state_functions.\ncallback_mode() -> handle_event_function.\n\n-define(KEEP_STATE(ReplyWith),\n    {keep_state, Data, [{reply, From, ReplyWith}]}\n).\n\nstart() ->\n    gen_statem:start({local, ?MODULE}, ?MODULE, [], []).\n\nstop() ->\n    gen_statem:stop(?MODULE).\nterminate(_Reason, _State, _Data) ->\n    void.\ncode_change(_Vsn, State, Data, _Extra) ->\n    {ok, State, Data}.\n\n%% Initial state and data\ninit([]) ->\n    State = no_state, \n    Data = 0,\n    {ok,State,Data}.\n\n%%% handle event function\n\nhandle_event(\n  {call, From},\n  <<\"push\">>,\n  off,\n  Data\n) ->\n    {next_state, on, Data + 1, [{reply, From, <<\"ok\">>}]};\n\nhandle_event(\n  {call, From},\n  <<\"push\">>,\n  on,\n  Data\n) ->\n    {next_state, off, Data, [{reply, From, <<\"ok\">>}]};\n\nhandle_event(\n  {call, From},\n  <<\"get_count\">>,\n  _CurrState,\n  Data\n) ->\n    {keep_state, Data, [{reply, From, Data}]};\n\n%%\n%% Fall through.\nhandle_event({call, From} = EventType, Stiff, State, Data) ->\n    io:format(\"TEST (call): ~p ~p ~p ~p~n\",[EventType, Stiff, State, Data]),\n    ?KEEP_STATE(<<\"not_allowed\">>);\n\nhandle_event(EventType, Stiff, State, Data) ->\n    io:format(\"TEST : ~p ~p ~p ~p~n\",[EventType, Stiff, State, Data]),\n    {keep_state, Data}.\n",
        }
        
        e.preventDefault()
        
        let content = templateCode[$(e.target).data('template-type')]
        if ($('#checkmarkconfirm').is(":checked") || confirm("Replace existing code?") ) {
          this.editor.setValue(content)
        }
      })
    },

    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;      
    },

    oneditsave: function() {
      this.code = this.editor.getValue();
      this.editor.destroy();
      delete this.editor;      
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="erlmodule">
  <div class="form-row">
    <label for="node-input-module_name"><i class="fa fa-tag"></i> <span data-i18n="erlmodule.label.module_name"></span></label>
    <input type="text" id="node-input-module_name" data-i18n="[placeholder]erlmodule.label.module_name">
  </div>
  
  <div class="form-row">
      <div style="height: 73vh; min-height:150px;" class="node-text-editor" id="node-input-erlmodule-editor"></div>
  </div>

  <div class="form-row">
    <input id="checkmarkconfirm" type="checkbox" checked style="width: 5%"></input>
    <button type=button class="template-button ui-button" data-template-type="module">Module</button>
    <button type=button class="template-button ui-button" data-template-type="event">Event</button>
    <button type=button class="template-button ui-button" data-template-type="state">State</button>
    <button type=button class="template-button ui-button" data-template-type="server">Server</button>
  </div>

  <div class="form-row" style="padding-bottom: 20px; margin-bottom: 10px;">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="erlmodule.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]erlmodule.label.name">
  </div>

</script>
